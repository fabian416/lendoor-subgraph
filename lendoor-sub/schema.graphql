"""
Actividad del vault: depósitos, retiros, borrows, repays.
Event-based feed => immutable.
"""
type VaultActivity @entity(immutable: true) {
  id: ID!

  type: String! # DEPOSIT | WITHDRAW | BORROW | REPAY
  account: Bytes!
  counterparty: Bytes

  assets: BigInt!
  shares: BigInt

  txHash: Bytes!
  logIndex: BigInt!

  blockNumber: BigInt!
  blockTimestamp: BigInt!
}

"""
Snapshots del estado del vault (para APY, gráficas, etc.)
Event-based => immutable.
"""
type VaultStatusSnapshot @entity(immutable: true) {
  id: ID!

  totalShares: BigInt!
  totalBorrows: BigInt!
  accumulatedFees: BigInt!
  cash: BigInt!
  interestAccumulator: BigInt!
  interestRate: BigInt!

  vaultTimestamp: BigInt!

  blockNumber: BigInt!
  blockTimestamp: BigInt!
  txHash: Bytes!
  logIndex: BigInt!
}

"""
Identidad simple del borrower para contar únicos.
Se crea una vez => immutable.
"""
type Borrower @entity(immutable: true) {
  id: ID! # address hex string
  firstSeen: BigInt!
}

"""
Estado auxiliar del loan actual por borrower
para poder calcular interest en LoanClosed.

Se actualiza => mutable.
"""
type ActiveLoan @entity(immutable: false) {
  id: ID! # borrower address hex string
  principal: BigInt!
  amountDue: BigInt!

  feeBps: Int
  start: BigInt
  due: BigInt

  active: Boolean!
}

"""
Stats globales del protocolo.
Se actualiza en cada evento => mutable.
"""
type ProtocolStat @entity(immutable: false) {
  id: ID! # "global"
  loansOriginated: BigInt!
  uniqueBorrowers: BigInt!

  principalOriginated: BigInt!
  principalRepaid: BigInt!
  interestRepaid: BigInt!

  lastUpdated: BigInt!
}

"""
Stats diarios (para gráficos).
Se actualiza durante el día => mutable.
"""
type DailyProtocolStat @entity(immutable: false) {
  id: ID! # dayStart timestamp string
  dayStart: BigInt!

  loansOriginated: BigInt!
  uniqueBorrowers: BigInt!

  principalOriginated: BigInt!
  principalRepaid: BigInt!
  interestRepaid: BigInt!

  lastUpdated: BigInt!
}

"""
Feed financiero real del LoanManager.
Event-based => immutable.

Opcional pero recomendado para UI de activity con interés.
"""
type LoanActivity @entity(immutable: true) {
  id: ID!

  type: String! # OPEN | CLOSE | DEFAULT
  borrower: Bytes!

  principal: BigInt
  amountDue: BigInt
  paid: BigInt
  interest: BigInt

  txHash: Bytes!
  logIndex: BigInt

  blockNumber: BigInt!
  blockTimestamp: BigInt!
}
